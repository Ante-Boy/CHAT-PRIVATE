<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Management - Admin Panel</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <header class="header">
    <div class="container header-content">
      <h1 class="logo">User Management</h1>
      <nav class="nav">
        <a href="admin.html">Admin Home</a>
        <a href="chat.html">Chatroom</a>
        <button id="logoutBtn" class="btn btn--secondary">Logout</button>
      </nav>
    </div>
  </header>

  <main class="container main-content">
    <section>
      <h2>Users</h2>
      <table id="usersTable" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align: left; padding: 8px;">Username</th>
            <th style="text-align: left; padding: 8px;">Role</th>
            <th style="text-align: left; padding: 8px;">Status</th>
            <th style="text-align: left; padding: 8px;">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section style="margin-top: 24px;">
      <h2>Add New User</h2>
      <form id="addUserForm" style="max-width: 400px;">
        <div class="form-group">
          <label for="newUsername" class="form-label">Username</label>
          <input id="newUsername" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="newPassword" class="form-label">Password</label>
          <input id="newPassword" type="password" class="form-control" required />
        </div>
        <div class="form-group">
          <label for="newRole" class="form-label">Role</label>
          <select id="newRole" class="form-control" required>
            <option value="agent" selected>Agent</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <button type="submit" class="btn btn--primary">Add User</button>
        <p id="addUserMsg" style="margin-top: 12px;"></p>
      </form>
    </section>
  </main>

  <script src="js/main.js"></script>
  <script>
  // Add this script block to your existing main.js or inject here for user management:

  (function() {
    const el = id => document.getElementById(id);

    async function apiRequest(path, method = 'GET', data = null) {
      const options = { method, headers: { 'Content-Type': 'application/json' } };
      if (data) options.body = JSON.stringify(data);
      const response = await fetch(path, options);
      if (!response.ok) {
        let errMsg = response.statusText;
        try {
          const errData = await response.json();
          errMsg = errData.error || errMsg;
        } catch {}
        throw new Error(errMsg);
      }
      return response.json();
    }

    let currentUser = null;

    async function fetchAndRenderUsers() {
      try {
        const users = await apiRequest('/api/users');
        const tbody = el('usersTable').querySelector('tbody');
        tbody.innerHTML = '';
        users.forEach(user => {
          const tr = document.createElement('tr');

          const tdUsername = document.createElement('td');
          tdUsername.textContent = user.username;
          tdUsername.style.padding = '8px';

          const tdRole = document.createElement('td');
          tdRole.textContent = user.role;
          tdRole.style.padding = '8px';

          const tdStatus = document.createElement('td');
          tdStatus.textContent = user.online ? 'Online' : 'Offline';
          tdStatus.style.padding = '8px';

          const tdActions = document.createElement('td');
          tdActions.style.padding = '8px';

          const editBtn = document.createElement('button');
          editBtn.textContent = 'Edit';
          editBtn.className = 'btn btn--primary';
          editBtn.style.marginRight = '8px';
          editBtn.addEventListener('click', () => openEditUserModal(user));

          tdActions.appendChild(editBtn);

          if (user.username !== currentUser.username) {
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'btn btn--secondary';
            deleteBtn.addEventListener('click', () => deleteUser(user.id));
            tdActions.appendChild(deleteBtn);
          }

          tr.appendChild(tdUsername);
          tr.appendChild(tdRole);
          tr.appendChild(tdStatus);
          tr.appendChild(tdActions);

          tbody.appendChild(tr);
        });
      } catch (err) {
        alert('Failed to load users.');
      }
    }

    async function addUser(event) {
      event.preventDefault();
      const username = el('newUsername').value.trim();
      const password = el('newPassword').value.trim();
      const role = el('newRole').value;
      if (!username || !password) return;

      try {
        await apiRequest('/api/users', 'POST', { username, password, role });
        el('addUserMsg').textContent = 'User added successfully.';
        el('addUserMsg').style.color = 'green';
        el('addUserForm').reset();
        fetchAndRenderUsers();
      } catch (err) {
        el('addUserMsg').textContent = err.message || 'Failed to add user.';
        el('addUserMsg').style.color = 'var(--color-error)';
      }
    }

    async function openEditUserModal(user) {
      const newUsername = prompt('Edit username:', user.username);
      if (newUsername === null) return;
      const newRole = prompt('Edit role (admin/agent):', user.role);
      if (newRole === null) return;
      const newPassword = prompt('New password (leave blank to keep):', '');
      try {
        await apiRequest('/api/users/' + user.id, 'PUT', {
          username: newUsername.trim(),
          role: newRole.trim(),
          password: newPassword ? newPassword : undefined
        });
        alert('User updated successfully.');
        fetchAndRenderUsers();
      } catch (err) {
        alert(err.message || 'Failed to update user.');
      }
    }

    async function deleteUser(userId) {
      if (!confirm('Are you sure you want to delete this user?')) return;
      try {
        await apiRequest('/api/users/' + userId, 'DELETE');
        alert('User deleted.');
        fetchAndRenderUsers();
      } catch (err) {
        alert(err.message || 'Failed to delete user.');
      }
    }

    function initUserManagementPage() {
      currentUser = (() => {
        const userStr = sessionStorage.getItem('currentUser');
        if (!userStr) {
          window.location.href = 'login.html';
          return null;
        }
        return JSON.parse(userStr);
      })();
      if (!currentUser || currentUser.role !== 'admin') {
        alert('Access denied. Admins only.');
        window.location.href = 'login.html';
        return;
      }

      el('logoutBtn').addEventListener('click', () => {
        sessionStorage.removeItem('currentUser');
        window.location.href = 'login.html';
      });

      el('addUserForm').addEventListener('submit', addUser);

      fetchAndRenderUsers();
    }

    if (window.location.pathname.endsWith('user-management.html')) {
      initUserManagementPage();
    }
  })();
  </script>
